<%- include('partials/header', { title: 'Admin Dashboard' }) %>

<!-- Header and Logout Button -->
<div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>Admin Dashboard</h2>
    <form method="post" action="/admin/logout">
        <button type="submit" class="btn-danger" style="width: auto; padding: 10px 15px;">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </form>
</div>

<!-- Status Cards -->
<div class="admin-status-grid">
    <!-- Total Jobs Status Card -->
    <div class="card status-card">
        <div>
            <p class="text-muted">Total Jobs</p>
            <h4><%= (jobs && Array.isArray(jobs)) ? jobs.length : 0 %></h4>
        </div>
        <div class="icon"><i class="fas fa-briefcase"></i></div>
    </div>
    
    <!-- Total Applications Status Card -->
    <div class="card status-card">
        <div>
            <p class="text-muted">Total Applications</p>
            <h4><%= (applications && Array.isArray(applications)) ? applications.length : 0 %></h4>
        </div>
        <div class="icon"><i class="fas fa-users"></i></div>
    </div>
</div>

<!-- Tabbed Content -->
<section class="card">
    <div class="tab-nav">
        <!-- Tab Buttons -->
        <button id="tabManageJobs" onclick="switchAdminTab('jobs')">Manage Jobs</button>
        <button id="tabApplications" onclick="switchAdminTab('applications')">Applications</button> 
        <button class="btn-add-job" onclick="document.getElementById('postJobForm').style.display='block';">
             <i class="fas fa-plus"></i> Add New Job
        </button>
    </div>

    <!-- Job Posting Form (Hidden by default, shown via button click) -->
    <div id="postJobForm" style="display:none; padding: 20px 0; border-top: 1px solid var(--color-border); margin-top: 20px;">
      <h3 style="text-align: left; margin-bottom: 20px;">Post New Job</h3>
      <form method="post" action="/admin/jobs">
        <label>Job Title</label><input name="title" required placeholder="e.g., Chemical Engineer">
        <label>Location</label><input name="location" required placeholder="e.g., Hyderabad, India">
        <label>Openings</label><input name="openings" type="number" min="1" value="1" required>
        <label>Experience (years)</label><input name="experience" type="number" min="0" max="50" value="0" required>
        <label>Description</label><textarea name="description" required></textarea>
        <div style="display: flex; justify-content: flex-start; gap: 10px;">
            <button type="submit" style="width: auto;">Post Job</button>
            <button type="button" class="btn-danger" style="width: auto; margin-left: 0;" onclick="document.getElementById('postJobForm').style.display='none';">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Existing Jobs Section (Content for the 'Manage Jobs' tab) -->
    <div id="contentJobs">
        <h3 style="margin-top: 40px; border-top: 1px solid var(--color-border); padding-top: 20px;">Job Listings</h3>
        <% if (jobs && Array.isArray(jobs) && jobs.length) { %>
            <ul class="job-list">
            <% jobs.slice().reverse().forEach(job => { %>
                <li>
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <div>
                            <strong class="text-blue"><%= job.title %></strong> — <%= job.location %>
                            <p style="font-size: 0.9rem; margin-top: 5px;">
                                Openings: <%= job.openings || 1 %> • Exp: <%= job.experience || 0 %> yrs
                            </p>
                        </div>
                        <div>
                            <form method="post" action="/admin/jobs/<%= job.id %>/delete" onsubmit="return confirm('Delete this job?');">
                                <button type="submit" class="btn-danger" style="width: auto; padding: 6px 12px; margin-top: 0;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </li>
            <% }) %>
            </ul>
        <% } else { %>
            <p class="text-center" style="padding: 20px 0;">No jobs posted yet</p>
        <% } %>
    </div>
    
    <!-- Applications Section (Content for the 'Applications' tab) -->
    <div id="contentApplications" style="display:none;">
        <h3 style="margin-top: 40px; border-top: 1px solid var(--color-border); padding-top: 20px;">Applications</h3>
        <% 
        var applicationsList = (typeof applications !== 'undefined' && Array.isArray(applications)) ? applications : [];
        %>
        <% if (applicationsList.length) { %>
            <ul class="job-list">
            <% applicationsList.slice().reverse().forEach(a => { %>
                <li>
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <div>
                            <strong class="text-blue"><%= a.name %></strong> applied for <%= (jobs && Array.isArray(jobs) && jobs.find(j => j.id === a.jobId)) ? jobs.find(j => j.id === a.jobId).title : 'Unknown Job' %>
                            <p style="font-size: 0.9rem; margin-top: 5px;">
                                Email: <%= a.email %> | Phone: <%= a.phone %> | Applied: <%= new Date(a.appliedAt).toLocaleDateString() %>
                            </p>
                             <% if (a.resume) { %>
                                <a href="<%= a.resume %>" target="_blank" style="font-size: 0.9rem;">
                                    Download Resume
                                </a>
                            <% } %>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <!-- NEW: Reject Button -->
                            <form method="post" action="/admin/applications/<%= a.id %>/reject" onsubmit="return confirm('Are you sure you want to REJECT this application? A rejection email will be sent.');">
                                <button type="submit" class="btn-text-link" style="width: auto; padding: 6px 12px; margin-top: 0; color: #dc2626; border: 1px solid #dc2626; border-radius: 8px; background: none;">
                                    <i class="fas fa-times-circle"></i> Reject
                                </button>
                            </form>
                            <!-- Existing Delete Button -->
                            <form method="post" action="/admin/applications/<%= a.id %>/delete" onsubmit="return confirm('Delete this application permanently?');">
                                <button type="submit" class="btn-danger" style="width: auto; padding: 6px 12px; margin-top: 0;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </li>
            <% }) %>
            </ul>
        <% } else { %>
            <p class="text-center" style="padding: 20px 0;">No applications yet</p>
        <% } %>
    </div>

</section>

<script>
    // Tab switching logic for Admin Dashboard
    function switchAdminTab(tabName) {
        // This function ensures only ONE content area is visible at a time (mutual exclusion)
        const tabs = ['jobs', 'applications'];
        
        tabs.forEach(tab => {
            const button = document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1));
            const content = document.getElementById('content' + tab.charAt(0).toUpperCase() + tab.slice(1));
            
            if (!button || !content) {
                return;
            }
            
            if (tab === tabName) {
                // Show the selected tab and set button as active
                button.classList.add('active');
                content.style.display = 'block';
            } else {
                // Hide the other tab content and remove active class
                button.classList.remove('active');
                content.style.display = 'none';
            }
        });

        // Always hide the Post Job form when switching tabs
        document.getElementById('postJobForm').style.display = 'none';
    }
    
    // Initial state setup: Ensure correct tab is shown on load
    document.addEventListener('DOMContentLoaded', function() {
        const jobsBtn = document.getElementById('tabManageJobs');
        const appsBtn = document.getElementById('tabApplications');
        const jobsContent = document.getElementById('contentJobs');
        const appsContent = document.getElementById('contentApplications');
        
        if (jobsBtn && appsBtn && jobsContent && appsContent) {
            // Initial State: Show Jobs, Hide Applications (By calling the function)
            switchAdminTab('jobs');
        } 
    });

</script>

<%- include('partials/footer') %>
